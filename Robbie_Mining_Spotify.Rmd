---
title: "Robbie_Spotify_Minning"
author: "R Freeman"
date: "8/18/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Minning the Spotify data via API 

```{r eval=FALSE, include=FALSE}

# devtools::install_github('charlie86/spotifyr')

library(spotifyr)

#set system enviroment variables for client ID and Secret ID
Sys.setenv(SPOTIFY_CLIENT_ID = '6b99e144dd674a0cba426bc94c823929')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '44727842431e4f3cb1909db30515aa70')

access_token <- get_spotify_access_token()

# pull in artist inormations such as genere, num followers, and popularity
for (i in 1:nrow(spotify_artists)) {
  if (i == 1){
    numFollowers <- get_artists(as.character(spotify_artists$dbname[i]))
  }else {
    tryCatch({
      numFollowers <- rbind(numFollowers, get_artists(as.character(spotify_artists$dbname[i])))},error=function(cond)
      {
        NA
      })
  }
  cat(paste0('\nFinished: ', i, ". Starting next loop on " , i+1, sep =' '))
}

# pull in album audio features 
for (i in 1:nrow(spotify_artists)) {
  if (i == 1){
    final_data <- get_artist_audio_features(as.character(spotify_artists$dbname[i]))
  }else {
    tryCatch({
      final_data <- rbind(final_data, get_artist_audio_features(as.character(spotify_artists$dbname[i])))},error=function(cond)
      {
        NA
      })
  }
  cat(paste0('\nFinished: ', i, ". Starting next loop on " , i+1, sep =' '))
}
```

Joining data sets and cleaning 

```{r}
library(plyr)

# combining data sets 
combinedData <- join(final_data, numFollowers, by='artist_name', type='left', match='all')


```

For purposes of this project we only care about artists with more than 1M followers, will filter out less popular artists. 

```{r}

# Lets filter out artists base don number of followers
combinedData2 <-na.omit(combinedData)
# removing duplicate artist_uri column 

combinedData2 <- combinedData2[colnames(combinedData2) != "artist_uri"]

# dopping genre beccause of issues with list data type, may want to add back later 
combinedData2 <- combinedData2[colnames(combinedData2) != "artist_genres"]
combinedData2 <- filter(combinedData2, track_popularity >= 1)
combinedData2 <- filter(combinedData2, artist_popularity >= 1)
combinedData3 <- filter(combinedData2, artist_num_followers >= 1000000)


```

Let's view the final dataset

```{r}

head(combinedData3)

```


Splitting into training and test data 

```{r}

#75% of the sample size
smp_size <- floor(0.75 * nrow(combinedData3))

#set the seed to make partition reproducible
set.seed(123)
train_ind <- sample(seq_len(nrow(combinedData3)), size = smp_size)

train <- combinedData3[train_ind, ]
test <- combinedData3[-train_ind, ]
```



Building the regression model 


```{r}
library(performanceEstimation)
library(forecast)
attach(train)

# trying linear model based on track popularity 
linearModel <- lm(artist_popularity ~ loudness + danceability + energy + acousticness +liveness + instrumentalness + track_popularity + is_collaboration + key + artist_num_followers + valence, data = train)

# tried step wise regression, currently not working
linearModel_step <- step(lm(artist_popularity ~ loudness + danceability + energy + acousticness +liveness + instrumentalness + track_popularity + is_collaboration + key + artist_num_followers + valence, data = train))


```
   
Let's look at the results of lm regression: 

```{r}
summary(linearModel)
summary(linearModel_step)

```




Random Forest Model 

```{r}
library(randomForest)
#Spotify.rf=randomForest(artist_name ~ . , data = train)
#Spotify.rf

```


Data Viz 


Plotting the number of followers an artist has versus popularity 

```{r}

plot(combinedData3$artist_num_followers, combinedData3$artist_popularity, xlab = "Number of Followers", ylab = "Artist Popularity")

```
Artist popularity versus track popularity 
```{r}
plot(combinedData3$artist_popularity, combinedData3$track_popularity, xlab = "Artist Popularity", ylab = "Track Popularity")


```




Artist versus number of followers  

```{r}
library(ggplot2)
library(tidyverse)

#Plotting artist popularity versus number of followers 

combinedData3 %>%  ggplot(aes(x=combinedData3$artist_popularity, y=combinedData3$artist_num_followers)) + geom_point()+ labs(x='Artist Popularity',y="Number of Followers (in Millions)") -> artist_plt
artist_plt

```
```{r}

combinedData3 %>%  ggplot(aes(x=combinedData3$artist_popularity, y=combinedData3$track_popularity)) + geom_point()+ labs(x='Artist Popularity',y="Track Popularity") -> track_plt
track_plt

```








```


